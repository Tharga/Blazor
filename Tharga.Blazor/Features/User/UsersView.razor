@using Microsoft.AspNetCore.Authorization
@using Tharga.Team
@typeparam TMember where TMember : class, Tharga.Team.ITeamMember
@attribute [Authorize(Roles = "Developer")]
@inject ITeamService TeamService
@inject IUserService UserService

@if (_teams == null)
{
    <Loading />
}
else
{
    <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
        <RadzenCard>
            <RadzenText>Users</RadzenText>
            <RadzenDataGrid Data="@_users" TItem="IUser">
                <Columns>
                    <RadzenDataGridColumn Title="Key" Property="@nameof(IUser.Key)"/>
                    <RadzenDataGridColumn Title="Identity" Property="@nameof(IUser.Identity)"/>
                    <RadzenDataGridColumn Title="EMail" Property="@nameof(IUser.EMail)"/>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
        @* <RadzenCard>
            <RadzenText>Members</RadzenText>
            <RadzenDataGrid Data="@_members" TItem="UserModel">
                <Columns>
                    <RadzenDataGridColumn Title="Key" Property="@nameof(UserModel.Key)"/>
                    <RadzenDataGridColumn Title="EMail" Property="@nameof(UserModel.EMail)"/>
                    <RadzenDataGridColumn Title="Last Seen" Property="@nameof(UserModel.LastSeen)">
                        <Template>
                            <DateTimeView Date="@context.LastSeen"/>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Title="Teams">
                        <Template>
                            @string.Join(", ", context.Teams.Select(x => x.Name))
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard> *@
        <RadzenCard>
            <RadzenText>Teams</RadzenText>
            <RadzenDataGrid Data="@_teams" TItem="ITeam">
                <Columns>
                    <RadzenDataGridColumn Title="Key" Property="Key"/>
                    <RadzenDataGridColumn Title="Icon" Property="Icon"/>
                    <RadzenDataGridColumn Title="Name" Property="Name"/>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </RadzenStack>
}

@code {
    private IUser[] _users;
    private ITeam[] _teams;
    // private UserModel[] _members;

    protected override async Task OnInitializedAsync()
    {
        _users = await UserService.GetAsync().ToArrayAsync();
        _teams = await TeamService.GetTeamsAsync<TMember>().ToArrayAsync();
        // _members = _teams
        //     .Where(x => x.Members != null)
        //     .SelectMany(x => x.Members)
        //     .GroupBy(x => (K: x.Key, E: x.EMail))
        //     .Select(x => new UserModel
        //     {
        //         Key = x.Key.K,
        //         EMail = x.Key.E,
        //         LastSeen = x.Min(x => x.LastSeen),
        //         Teams = _teams.Where(y => y.Members != null && y.Members.Any(z => z.EMail == x.First().EMail)).OrderBy(y => y.Name).ToArray<ITeam>()
        //     })
        //     .ToArray();

        await base.OnInitializedAsync();
    }

}
